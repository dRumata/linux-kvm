# fedora 
dnf module install virt -y
dnf install -y virt-install virt-viewer
virt-host-validate
systemctl enable --now libvirtd.service
dnf install cockpit cockpit-machines -y
systemctl enable --now cockpit.socket

# almalinux
sudo dnf groupinstall "Server with GUI"
``` bash
Источник:  /etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux-9
Продолжить? [д/Н]:
```
sudo dnf install epel-release
sudo dnf install neovim git tmux mc curl ripgrep gcc -y

tee ~/.tmux.conf << _EOF_
set -g mouse on
set -g status-style bg=black
set -g window-status-current-style bg=yellow,fg=black,bold
set -g status-right '#(curl -s wttr.in/Hamburg:Москва:Челябинск:Иркутск:Владивосток\?format\="%%l:+%%c%%20%%t%%60%%w&period=20") ...'
#set -g status-right '#(curl "wttr.in/?format=3") '
set -g default-terminal "tmux-256color"

set -g status-interval 10
set -g status-left-length 30
set -g status-left '#[fg=green]#(cut -d " " -f 1-3 /proc/loadavg)#[default] #[fg=cyan]%H:%M#[default] '
_EOF_


sudo systemctl enable --now cockpit.socket


sudo systemctl set-default graphical.target
Добавьте еще один диск к вм 64G
скачайте образы iso
reboot



dnf install -y virt-install virt-viewer virt-manager
virt-host-validate
systemctl enable --now libvirtd.service
dnf install cockpit cockpit-machines -y
sudo usermod -aG libvirtdbus,libvirt,qemu,kvm student



запустите в графической сесссим терминал
virt-manager

выберите QEMU/KVM
выберите Пространство данных затем добавить пул - "плюс" слева внизу окна
Название iso
путь к цели /var/lib/libvirt/images/iso

в браузере скачайте iso образ oracle.com/linux
или wget https://yum.oracle.com/ISOS/OracleLinux/OL9/u5/x86_64/OracleLinux-R9-U5-x86_64-boot-uek.iso 


скачайте https://www.alpinelinux.org/cloud/
https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/cloud/generic_alpine-3.20.3-x86_64-bios-cloudinit-r0.qcow2

Сделайте snapshot

## 1. Практическая работа 
запустите в графической сессси терминал
virt-manager
выберите QEMU/KVM
выберите Пространство данных затем добавить пул - "плюс" слева внизу окна
Название demopool
выберите Пространство данных затем добавить пул - "плюс" слева внизу окна
Название demoiso

Переключитесь в терминал и создайте новую volume group


добавьте третье пространство
demo_vmdata

Создайте симлинки для удобства копирования

Скопируйте iso и qcow

Убедитесь что диски добавлены

Выберите demo_vmdata
Создайте demovol
Убедитесь в консоли что диск существует
Создайте в консоли еще один диск
Обновите и убедитесь что диск появился
Вернитесь к ранее созданному snapshot

## 1. Лабораторная
1. Cоздайте группу томов vgvmpool состоящую из диска /dev/sdb (64G)
2. Добавьте новый pool с именем "iso" связанным с каталогом /var/lib/libvirt/images/iso
3. Добавьте новый pool с именем "vmpool_dir" связанным с каталогом /var/lib/libvirt/images/vmpool_dir
4. Скопируйте файлы iso-образов в pool "iso"
5. Скопируйте файл qcow-образа в pool "vmpool_dir"
6. Создайте новый logical-pool с именем "vmpool_vg", группу томов укажите ранее созданную vgvmpool.
7. Создайте в пуле "vmpool_vg" два диска "vol8gb" и "vol2gb" объемом 8 и 2 Gb соответственно. Воспользуйтесь графическим и консольным способом.
8. Сохраните состояние рабочего стенда сделав snapshot_lab1.

## 2. Практическая работа 

Переключитесь в Виртуальные сети
Нажмите + и создайте сеть demonat1 настройте ipv4 dhcp
Нажмите + и создайте сеть demorouted1 настройте ipv4 dhcp
Нажмите + и создайте сеть demoisolated1 настройте ipv4 dhcp
Просмотрите информацию о сетвых интерфейсах в консоли.

## 2. Лабораторная
1. Создайте сеть lab2nat1 со следующими параметрами:
- режим: NAT
- сеть IPv4 192.168.101.0/24
- DHCPv4 диапозон 192.168.101.100-150

2. Создайте сеть lab2routed1 со следующими параметрами:
- режим: Маршрутизируемая
- сеть IPv4 172.16.101.0/24
- DHCPv4 диапозон 172.16.101.100-150

3. Создайте сеть lab2isolated1 со следующими параметрами:
- режим: Изолированая
- сеть IPv4 10.10.101.0/24
- DHCPv4 диапозон 10.10.101.100-150

4. Прверьте в консоли что адреса на виртуальные бриджи назначены из настроеных сетей.

5. Сохраните состояние рабочего стенда сделав snapshot_lab2.

## 3. Практическая работа
Создать виртуальную машину
Установка вручную
На втором шаге выберите alpine
На третьем шаге оставьте значения по умолчанию или укажите свои значения памяти процессора

на  четвёртом шаге создайте диск размером 2 ГБ: Выберите выбрать или создать дополнительное пространство данных
 в окне расположения и создания томов в хранилище укажите vmpool_dir затем нажмите плюс для создания тома
  в окне добавления Тома добавьте том размером 2 ГБ нажмите готово
   расположение выберите вновь созданный том и нажмите choose volume
    нажмите далее
     на пятом шаге измените название виртуальной машины на demo_alpine поставьте галочку проверить конфигурацию перед установкой откройте выбор сети и выберите сеть lab2_nat11 затем нажмите готово

Окне настройки машины выберите добавить оборудование
 выберите первое значение хранилища и затем тип устройства укажите cdrom
 нажмите кнопку настроить затем выберите pool iso  и выберите диск alpine...
  Нажмите готово добавление оборудования
   в окне настройки виртуальной машины выберите параметры загрузки поставить галочку напротив сата CDROM и поднимите его вверх в приоритет загрузки
   нажмите apply и затем начать установку

root
setup-alpine
us
us
настройка сети все по умолчанию, убедитесь что адлрес получили по dhcp
 выполните все шаги по установке виртуальной машины операционной системы и выключите машину

 отключить в настройках виртуальной машины CDRom и включите машину


 Перключистесь в терминал хоста и подключитесь по ssh к своей виртуальной машине (ip можно увидеть на экране виртуальной машины)

 Создайте новую виртуальную машину
 Выберите установка вручную
  на втором шаге укажите alpine
На третьем шаге оставьте значения по умолчанию или укажите свои значения памяти процессора
на  четвёртом шаге Выберите выбрать или создать дополнительное пространство данных

в окне расположения и создания томов в хранилище укажите vmpool_dir затем  выберите диск generic_alpine

 изменить название виртуальной машины на demo_alpine_qcow нажмите проверить конфигурацию галочку и выберите нужную сеть lab2routed1

 проверьте настроенные элементы виртуальной машины и затем нажмите начать установку
Сделайте snapshot

 ## 3. Лабораторная работа
 1. Создайте вируальную машину с lab3alpine со следующими параметрами:
 - память 1024Mb
 - процессор 1
 - диск используйтен ранее созданный vol2gb на vmpool_vg
 - сеть lab2nat1
 - подключите установочный диск alpine и установите операционную систему alpne
 2. Перезагрузите вм, уточните ip-адрес и подключитесь по ssh.
 3. Проверьте ping до github.com - ответ должен быть.
 4. Измените сеть с lab2nat1 на lab2routed1, перезапустите сетевой интерфейс и убедитесь что ip адрес сменился на адрес из сети 172.16.101.0/24.
 5. Проверьте ping до github.com - ответа нет.
 6. Переключитесь на host c гипервизором и добавьте правила для брэндмауэра
```bash
firewall-cmd --add-forward --permanent
firewall-cmd --add-masquerade --permanent
firewall-cmd --reload
```
 7. Переключитесь в окно вм и снова проверьте ping до github.com - ответ должен быть. 
Сделайте snapshot




## 4. Практическая работа
1. Выберите правым щелчком мыши вм demo_alpine в менеджере виртуальных машин и в меню укажите пункт "Клонировать"
2. Убедитесь что галочка не установлена на iso-диске и нажмите клонировать
3. Выберите правым щелчком мыши вм demo_alpine в менеджере виртуальных машин и в меню укажите пункт "Клонировать" 
4. Выберите первый диск с данными (не iso) и нажмите подробности
5. В окне изменить путь к хранилищу выберите обзор, затем выбор Тома хранилища в vmpool_vg создайте новый том объемом 4G и нажмите choose volume
6. Клонирование завершиться неудачей
7. Попробуйте снова выбрать vmpool_dir и создать новый том.
8. Клонирование завершиться неудачей
9. Выберите первый диск с данными (не iso) и нажмите подробности, убедитесь что выбран vmpool_dir и в строке с именем файла после "vmpool_dir/" допишите новое имя disk2g.qcow и нажмите клонировать
10. Клонирование завершиться  успешно.
11. Включите обе машины и убедитесь что ни работают, например ping на выданные для этих машин адреса работает.
12. По очереди правым щелчком на двух созданных вм выберите удалить и удалите созданные вм.

## 4. Лабораторная работа
1. Выключите вм lab3alpine
2. Создайте клон и назовите lab4alpine-clone1, хранилище не изменяйте (должен быть vmpool_vg)
3. Создайте клон и назовите lab4alpine-clone2, хранилище измените на vmpool_dir
4. Проверьте содержимое /var/lib/libvirt/images/vmpool_dir/ с помощью `ls -lhs` Сделайте выводы о реальных размерах файлов qcow.
5. Включите и проверьте доступность обееих вм
6. Выключите клонированные вм
7. Сделайте снапшот
   
## 5. Практическая работа 
1. Выберите вм "demo_alpine" и после двойного клика в открывшемся окне вм выберите крайнюю правую иконку "Управление снимками"
2. Нажмите слева снизу  иконку "+" и затем готово
3. Включите вм demo_alpine и войдите на нее под учетной записью root
4. Создайте файл с текущей датой date.txt
```bash
echo $(date) > date.txt
```
5. В окне вм выберите управление снимками и запустите ранее созданный снимок.
6. Включите вм demo_alpine и проверьте существование date.txt - его не должно быть.
7. Удалите ранее созданный снимок

## 5. Лабораторная работа.
1. Попробуйте создать снимок вм lab4alpine-clone2

2. Операция не возможна. 

3. Удалите вм lab4alpine-clone2, но не удаляйте файлы пространства хранения. Запомните как назывался файл диска удаляемой машины.

4. Перключитесь в терминал хоста гипервизора и проверьте формат файла диска:
```bash
cd /var/lib/libvirt/images/vmpool_dir
sudo qemu-img info your_file.qcow2
```
5. Сконвертируйте образ диска из RAW в QCOW2
```bash
sudo qemu-img convert -f raw -O qcow2 your_file.qcow2 lab5alpine.qcow2
```
> Здесь your_file.qcow2 — это ваш исходный файл в формате RAW, а output.qcow2 — это имя файла, который будет создан в формате QCOW2.
 
6. Создайте новую вм lab5alpine при создании используйте пункт Импорт образа диска, в качестве образа диска укажите ранее сконвертированный диск. Сеть укажите: lab1nat1

2. Сделайте 1-й снимок вм
3. Войдите на нее под учетной записью root
4. Создайте файл с текущей датой date.txt
```bash
echo $(date) > date.txt
```
1. Установите в вм apache2
```bash
apk update
apk add apache2
rc-service apache2 start
rc-update add apache2 default
```
1. Сделайте 2-й снимок вм
2. Запустите 1-й снимок вм и убедитесь, что файла date.txt не существует
3. Запустите 2-й снимок вм и убедитесь что служба apache2 работает:
```bash
netstat -tnlp|grep 80
```
